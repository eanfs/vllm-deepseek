version: '3.8'

services:
  deepseek-ocr2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: deepseek-ocr2-vllm
    runtime: nvidia
    # 临时使用 privileged 模式以排查 cgroups 权限问题
    privileged: true
    ipc: host
    entrypoint: ["/app/entrypoint.deepseek-ocr.sh"]
    environment:
      # 模型配置
      - MODEL_ID=deepseek-ai/DeepSeek-OCR
      - MODELSCOPE_CACHE=/models
      - GPU_MEMORY_UTILIZATION=0.75
      - MAX_MODEL_LEN=8192
      - HF_ENDPOINT=https://hf-mirror.com
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - TENSOR_PARALLEL_SIZE=2
    ports:
      - "8000:8000"
    volumes:
      - ./models:/models
      - ./entrypoint.deepseek-ocr.sh:/app/entrypoint.deepseek-ocr.sh:ro
    shm_size: '16gb'
    restart: unless-stopped
    
    # GPU 资源配置（使用 8 张卡）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 8
              capabilities: [gpu]