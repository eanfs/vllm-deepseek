version: '3.8'

services:
  deepseek-ocr2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: deepseek-ocr2-vllm
    runtime: nvidia
    # 临时使用 privileged 模式以排查 cgroups 权限问题
    privileged: true
    ipc: host
    environment:
      # 模型配置
      - MODEL_ID=unsloth/DeepSeek-OCR-2-bf16
      - MODELSCOPE_CACHE=/models
      - GPU_MEMORY_UTILIZATION=0.65
      - MAX_MODEL_LEN=4096
      - HF_ENDPOINT=https://hf-mirror.com
      - PYTORCH_CUDA_ALLOC_CONF=expandable_segments:True
      - EXTRA_ARGS=--enforce-eager
    ports:
      - "8000:8000"
    volumes:
      - ./models:/models
    shm_size: '16gb'
    restart: unless-stopped
    
    # GPU 资源配置（使用 deploy 方式分配 GPU）
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]